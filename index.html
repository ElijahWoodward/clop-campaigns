# Build a standalone interactive Sankey (Plotly) HTML from the provided dataset
import re, json, pandas as pd
from textwrap import dedent

raw = dedent("""
Campaign\tASN / Name\tCountry\tCount
Accellion File Transfer Appliance (FTA)\tAS-COLOCROSSING\t\t1
Accellion File Transfer Appliance (FTA)\tCROWNCLOUD\tAU\t1
Accellion File Transfer Appliance (FTA)\tGHOST\tLU\t1
Accellion File Transfer Appliance (FTA)\tHostzealot\tBG\t1
Accellion File Transfer Appliance (FTA)\tTIER-NET\tUS\t1
Accellion File Transfer Appliance (FTA)\tWORLDSTREAM\tNL\t1
SolarWinds Serv-U\tACI-1\tCA\t1
SolarWinds Serv-U\tASN-CXA-ALL-CCI-22773-RDC\tUS\t1
SolarWinds Serv-U\tHOSTKEY-AS\tNL\t1
SolarWinds Serv-U\tIT7NET\tCA\t1
SolarWinds Serv-U\tLAYER7-NETWORKS-\tDE\t2
SolarWinds Serv-U\tTWC-11427-TEXAS\tUS\t1
SolarWinds Serv-U\tVIANET INC 5690\tCA\t1
Fortra GoAnywhere MFT\tAMAZON-02\tUS\t1
Fortra GoAnywhere MFT\tAS-ALVIVA\tSC\t2
Fortra GoAnywhere MFT\tAS-COLOCROSSING\tUS\t1
Fortra GoAnywhere MFT\tBANDWIDTH-AS\tGB\t1
Fortra GoAnywhere MFT\tBT-UK-AS BTnet UK Regional network\tGB\t1
Fortra GoAnywhere MFT\tCLOUDFLARENET\tUS\t4
Fortra GoAnywhere MFT\tCOMCAST-7922\tUS\t1
Fortra GoAnywhere MFT\tDATACAMPUS\tHK\t3
Fortra GoAnywhere MFT\tDATAHOME S.A.\tPA\t3
Fortra GoAnywhere MFT\tDIGITALOCEAN-ASN\tUS\t2
Fortra GoAnywhere MFT\tFDCSERVERS\tUS\t3
Fortra GoAnywhere MFT\tGHOST\tLU\t1
Fortra GoAnywhere MFT\tGREENFLOID-AS\tUS\t2
Fortra GoAnywhere MFT\tHORMELFOODS\tUS\t1
Fortra GoAnywhere MFT\tHOSTROYALE\tIN\t1
Fortra GoAnywhere MFT\tHostzealot\tBG\t1
Fortra GoAnywhere MFT\tHostzealot\tBG\t3
Fortra GoAnywhere MFT\tHostzealot\tBG\t2
Fortra GoAnywhere MFT\tHostzealot\tBG\t5
Fortra GoAnywhere MFT\tI-LAN-AS\tUA\t1
Fortra GoAnywhere MFT\tITLDC-EU\tUS\t1
Fortra GoAnywhere MFT\tM247\tRO\t1
Fortra GoAnywhere MFT\tMICROSOFT-CORP-MSN-AS-BLOCK\tUS\t1
Fortra GoAnywhere MFT\tOVH\tFR\t4
Fortra GoAnywhere MFT\tPANDG\tUS\t1
Fortra GoAnywhere MFT\tSOLLUTIUM-NL\tPL\t1
Fortra GoAnywhere MFT\tTHCPROJECTS\tRO\t1
Fortra GoAnywhere MFT\tTHE-HOSTING\tMD\t1
Fortra GoAnywhere MFT\tTIF-AS Iliad Italia S.p.A\tFR\t1
Fortra GoAnywhere MFT\tTWC-10796-MIDWEST\tUS\t1
Fortra GoAnywhere MFT\tTWC-11426-CAROLINAS\tUS\t1
Fortra GoAnywhere MFT\tVNPT-AS-VN VNPT Corp\tVN\t2
Fortra GoAnywhere MFT\tXMISSION\tUS\t1
PaperCut MF/NG\tAMAZON-02\tUS\t2
PaperCut MF/NG\tAS-GLOBALTELEHOST\tUS\t2
PaperCut MF/NG\tASNET\tUS\t1
PaperCut MF/NG\tDATACAMPUS\tHK\t1
PaperCut MF/NG\tGREENFLOID-AS\tUS\t1
PaperCut MF/NG\tHETZNER-AS\tDE\t1
PaperCut MF/NG\tHEXTET\tCA\t1
PaperCut MF/NG\tHost-Africa-AS\tZA\t1
PaperCut MF/NG\tKREZ999AS\tBG\t1
PaperCut MF/NG\tM247\tRO\t1
PaperCut MF/NG\tNETWAVE-AS-AP\tUS\t1
PaperCut MF/NG\tNOVOSERVE-AS\tNL\t1
PaperCut MF/NG\tOVH\tFR\t1
PaperCut MF/NG\tSHARP-ASN\tUS\t1
PaperCut MF/NG\tSS-NET\tBG\t1
Progress MOVEit Transfer\tAS-ALVIVA\tSC\t5
Progress MOVEit Transfer\tAS-COLOCROSSING\tUS\t3
Progress MOVEit Transfer\tCLOUVIDER Clouvider - Global ASN\tGB\t3
Progress MOVEit Transfer\tCROWNCLOUD\tAU\t3
Progress MOVEit Transfer\tDATACAMPUS\tHK\t2
Progress MOVEit Transfer\tDELTAHOST-AS\tUA\t1
Progress MOVEit Transfer\tDELTAHOST-KYIV\tUA\t1
Progress MOVEit Transfer\tDIGITALOCEAN-ASN\tUS\t2
Progress MOVEit Transfer\tFLYSERVERS-ASN\tPA\t1
Progress MOVEit Transfer\tGHOST\tLU\t1
Progress MOVEit Transfer\tGLOBALCOMPASS\tUS\t2
Progress MOVEit Transfer\tGLOBALLAYER\tNL\t5
Progress MOVEit Transfer\tHOSTING-SOLUTIONS\tUS\t3
Progress MOVEit Transfer\tHOSTKEY-AS\tNL\t3
Progress MOVEit Transfer\tHostzealot\tBG\t5
Progress MOVEit Transfer\tHostzealot\tBG\t2
Progress MOVEit Transfer\tHostzealot\tBG\t2
Progress MOVEit Transfer\tINOVARE-AS str. Uzinelor 21 of. 37\tMD\t5
Progress MOVEit Transfer\tITLDC-EU\tUS\t1
Progress MOVEit Transfer\tLAYER7-NETWORKS-\tDE\t1
Progress MOVEit Transfer\tOVH\tFR\t2
Progress MOVEit Transfer\tRELIABLESITE\tUS\t2
Progress MOVEit Transfer\tSERVER-MANIA\tCA\t2
Progress MOVEit Transfer\tSOLLUTIUM-NL\tPL\t2
Progress MOVEit Transfer\tSONICASN\tLB\t1
Progress MOVEit Transfer\tTHCPROJECTS\tRO\t4
Progress MOVEit Transfer\tTHE-HOSTING\tMD\t1
Progress MOVEit Transfer\tWORLDSTREAM\tNL\t6
Progress MOVEit Transfer\tYURTEH-AS\tUA\t2
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tALEXHOST\tMD\t3
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tBALTNETA Customers AS\tLT\t1
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tBOGRAINFOCOM-AS-AP BograInfo.com\tBD\t1
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tCONTABO\tDE\t1
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tDATAHOME S.A.\tPA\t1
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tDIGITALOCEAN-ASN\tUS\t1
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tHOSTING-SOLUTIONS\tUS\t1
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tHOSTWINDS\tUS\t1
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tHostzealot\tBG\t1
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tINOVARE-AS str. Uzinelor 21 of. 37\tMD\t1
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tINT-NETWORK\tSC\t1
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tSCALAXY-AS\tLV\t2
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tSERVER-MANIA\tCA\t1
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tSERVERASTRA-AS\tHU\t1
Cleo MFT Solutions (Harmony, VLTrader, LexiCom)\tUNIFIEDLAYER-AS-1\tUS\t1
Oracle E-Business Suite\tASNET\tUS\t1
Oracle E-Business Suite\tCHIESI-AS\tIT\t1
Oracle E-Business Suite\tCONTABO\tDE\t1
Oracle E-Business Suite\tDATAHOME S.A.\tPA\t1
Oracle E-Business Suite\tGIGAHOST\tNO\t1
Oracle E-Business Suite\tHETZNER-AS\tDE\t1
Oracle E-Business Suite\tRELIABLESITE\tUS\t1
""").strip()

# Parse the tab-separated data into a DataFrame
rows = []
lines = raw.splitlines()
header = lines[0].split("\t")
for line in lines[1:]:
    parts = line.split("\t")
    # Expect 4 columns; if not, try to repair
    if len(parts) < 4:
        # Attempt regex fallback: campaign, asn, country (optional), count
        m = re.match(r"^(.*?)\s{2,}(.+?)\s{2,}([A-Z]{2})?\s*(\d+)$", line.strip())
        if m:
            campaign, asn, country, count = m.group(1), m.group(2), (m.group(3) or ""), m.group(4)
            parts = [campaign, asn, country, count]
        else:
            # last resort: split by two+ spaces
            parts = re.split(r"\s{2,}", line.strip())
            if len(parts) == 3:
                parts.insert(2, "")  # empty country
            if len(parts) != 4:
                raise ValueError(f"Unparsable line: {line}")
    campaign, asn, country, count = parts[0].strip(), parts[1].strip(), parts[2].strip(), int(parts[3])
    country = country if country else "Unknown"
    rows.append({"Campaign": campaign, "ASN": asn, "Country": country, "Count": count})

df = pd.DataFrame(rows)

# Aggregate duplicates (same Campaign + ASN + Country)
df_agg = df.groupby(["Campaign", "ASN", "Country"], as_index=False)["Count"].sum()

# Build Sankey nodes: campaigns + ASNs + countries
campaigns = df_agg["Campaign"].unique().tolist()
asns = df_agg["ASN"].unique().tolist()
countries = df_agg["Country"].unique().tolist()

# Node list and mapping
nodes = campaigns + asns + countries
idx = {name: i for i, name in enumerate(nodes)}

# Links: campaign -> ASN, and ASN -> Country (values are counts)
links = []
for r in df_agg.itertuples(index=False):
    # campaign -> asn
    links.append({"source": idx[r.Campaign], "target": idx[r.ASN], "value": int(r.Count),
                  "label": f"{r.Campaign} → {r.ASN}", "group": r.Campaign})
    # asn -> country
    links.append({"source": idx[r.ASN], "target": idx[r.Country], "value": int(r.Count),
                  "label": f"{r.ASN} → {r.Country}", "group": r.Campaign})

# Prepare per-campaign filtering (including "All")
campaign_options = ["All"] + campaigns

# Build HTML with Plotly.js, dropdown filters, and dark theme
html_template = f"""<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MFT Exploits Sankey</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root {{ color-scheme: dark; }}
    body {{
      margin: 0; padding: 0; background: #0b0f14; color: #e5e7eb;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }}
    header {{
      padding: 18px 24px; background: linear-gradient(90deg,#0b0f14,#121926,#0b0f14);
      border-bottom: 1px solid #111827;
      position: sticky; top: 0; z-index: 9;
    }}
    h1 {{ margin: 0; font-size: 20px; letter-spacing: .2px; }}
    .sub {{ opacity:.8; font-size: 13px; margin-top:4px }}
    #controls {{
      display:flex; gap:12px; align-items:center; padding:12px 24px; flex-wrap:wrap;
      background:#0d121a; border-bottom:1px solid #111827;
    }}
    select, button {{
      background:#111827; color:#e5e7eb; border:1px solid #1f2937; border-radius:10px; padding:8px 10px;
      font-size:14px;
    }}
    button:hover, select:hover {{ border-color:#374151; }}
    #chart {{ width:100%; height: calc(100vh - 150px); }}
    footer {{ padding:10px 16px; font-size:12px; opacity:.7 }}
    .pill {{
      display:inline-block; padding:2px 8px; border-radius:999px; background:#0e7490; margin-left:8px; font-size:12px;
    }}
  </style>
</head>
<body>
  <header>
    <h1>MFT Exploits · Interactive Sankey <span class="pill">Campaign → ASN → Country</span></h1>
    <div class="sub">Use the dropdown to focus by campaign. Drag to pan, scroll to zoom. Hover for counts.</div>
  </header>
  <div id="controls">
    <label for="campaign">Filter:</label>
    <select id="campaign"></select>
    <button id="reset">Reset View</button>
    <div style="opacity:.7;font-size:12px">Links shown: <span id="linkCount">–</span></div>
  </div>
  <div id="chart"></div>
  <footer>Built with Plotly.js. Save this file anywhere (e.g., GitHub Pages) and open in a browser.</footer>
<script>
const campaigns = {json.dumps(campaign_options)};
const nodes = {json.dumps(nodes)};
const linksAll = {json.dumps(links)};

// Build node arrays
const nodeLabels = nodes;
const nodeColors = nodes.map((n,i)=> i < {len(campaigns)-1} ? '#0ea5e9' : (i < {len(campaigns)-1 + len(asns)} ? '#a78bfa' : '#34d399'));

// Helper to filter links by campaign
function filteredLinks(camp) {{
  if (camp === "All") return linksAll;
  return linksAll.filter(l => l.group === camp);
}}

// Build sankey data from links
function sankeyFromLinks(links) {{
  return {{
    type: 'sankey',
    arrangement: 'snap',
    node: {{
      label: nodeLabels,
      color: nodeColors,
      pad: 20,
      thickness: 18,
      line: {{ color: 'rgba(255,255,255,0.08)', width: 1 }}
    }},
    link: {{
      source: links.map(l => l.source),
      target: links.map(l => l.target),
      value:  links.map(l => l.value),
      hovertemplate: links.map(l => l.label) ,
    }}
  }};
}}

const layout = {{
  title: '',
  font: {{ size: 12 }},
  paper_bgcolor: '#0b0f14',
  plot_bgcolor: '#0b0f14',
  margin: {{ l: 20, r: 20, t: 10, b: 20 }},
  hoverlabel: {{ bgcolor: '#111827', bordercolor: '#374151' }}
}};

const chart = document.getElementById('chart');
const select = document.getElementById('campaign');
const linkCount = document.getElementById('linkCount');
const resetBtn = document.getElementById('reset');

// Populate dropdown
campaigns.forEach(c => {{
  const opt = document.createElement('option');
  opt.value = c; opt.textContent = c;
  select.appendChild(opt);
}});

// Initial render (All)
let currentLinks = filteredLinks("All");
Plotly.newPlot(chart, [sankeyFromLinks(currentLinks)], layout, {{displaylogo:false, responsive:true}});
linkCount.textContent = currentLinks.length.toString();

// Handle filter change
select.addEventListener('change', () => {{
  currentLinks = filteredLinks(select.value);
  Plotly.react(chart, [sankeyFromLinks(currentLinks)], layout, {{displaylogo:false, responsive:true}});
  linkCount.textContent = currentLinks.length.toString();
}});

// Reset camera/view
resetBtn.addEventListener('click', () => {{
  Plotly.Plots.resize(chart);
}});

// Resize on window changes
window.addEventListener('resize', () => Plotly.Plots.resize(chart));
</script>
</body>
</html>
"""

out_path = "/mnt/data/mft_exploits_sankey.html"
with open(out_path, "w", encoding="utf-8") as f:
    f.write(html_template)

out_path
